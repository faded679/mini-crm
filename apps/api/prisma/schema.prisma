generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RequestStatus {
  new
  warehouse
  shipped
  done
}

enum PackagingType {
  pallets
  boxes
}

enum RateUnit {
  pallet
  kg
  m3
}

model Client {
  id           Int              @id @default(autoincrement())
  telegramId   String           @unique @map("telegram_id")
  username     String?
  firstName    String?          @map("first_name")
  lastName     String?          @map("last_name")
  consentGiven Boolean          @default(false) @map("consent_given")
  consentAt    DateTime?        @map("consent_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  requests     ShipmentRequest[]
  counterparties CounterpartyContact[]

  @@map("clients")
}

model Counterparty {
  id                    Int                   @id @default(autoincrement())
  name                  String
  inn                   String?
  kpp                   String?
  ogrn                  String?
  address               String?
  account               String?               @map("account")
  bik                   String?
  correspondentAccount  String?               @map("correspondent_account")
  bank                  String?
  director              String?
  contract              String?
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  contacts              CounterpartyContact[]
  invoices              Invoice[]

  @@map("counterparties")
}

model CounterpartyContact {
  id             Int          @id @default(autoincrement())
  counterpartyId Int          @map("counterparty_id")
  clientId       Int          @map("client_id")
  createdAt      DateTime     @default(now()) @map("created_at")

  counterparty   Counterparty @relation(fields: [counterpartyId], references: [id])
  client         Client       @relation(fields: [clientId], references: [id])

  @@unique([counterpartyId, clientId])
  @@map("counterparty_contacts")
}

model Manager {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  fieldChanges RequestFieldHistory[]

  @@map("managers")
}

model ShipmentRequest {
  id          Int                    @id @default(autoincrement())
  clientId    Int                    @map("client_id")
  cityId      Int                    @map("city_id")
  city        String                 @default("")
  deliveryDate DateTime             @map("delivery_date")
  volume      Float?
  size        String
  weight      Float?
  boxCount    Int                    @map("box_count")
  packagingType PackagingType        @default(boxes) @map("packaging_type")
  comment     String?
  status      RequestStatus          @default(new)
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")

  client       Client                 @relation(fields: [clientId], references: [id])
  cityRef      City                   @relation(fields: [cityId], references: [id])
  history      RequestStatusHistory[]
  fieldHistory RequestFieldHistory[]
  services     RequestService[]

  @@map("shipment_requests")
}

model City {
  id        Int         @id @default(autoincrement())
  shortName String      @unique @map("short_name")
  fullName  String      @map("full_name")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  rates     PriceRate[]
  requests  ShipmentRequest[]
  schedules DeliverySchedule[]

  @@map("cities")
}

model PriceRate {
  id          Int       @id @default(autoincrement())
  cityId      Int       @map("city_id")
  unit        RateUnit
  minWeightKg Int?      @map("min_weight_kg")
  maxWeightKg Int?      @map("max_weight_kg")
  minVolumeM3 Float?    @map("min_volume_m3")
  maxVolumeM3 Float?    @map("max_volume_m3")
  price       Int
  comment     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  city        City      @relation(fields: [cityId], references: [id])

  @@index([cityId, unit])
  @@map("price_rates")
}

model Invoice {
  id              Int           @id @default(autoincrement())
  number          String        @unique
  date            DateTime      @default(now())
  counterpartyId  Int           @map("counterparty_id")
  requestId       Int?          @map("request_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  counterparty    Counterparty  @relation(fields: [counterpartyId], references: [id])
  items           InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int      @map("invoice_id")
  description String
  quantity    Float    @default(1)
  unit        String   @default("шт")
  price       Float
  amount      Float

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model DeliverySchedule {
  id            Int      @id @default(autoincrement())
  cityId        Int      @map("city_id")
  destination   String   @default("")
  deliveryDate  DateTime @map("delivery_date")
  acceptDays    String   @map("accept_days")
  createdAt     DateTime @default(now()) @map("created_at")

  cityRef       City     @relation(fields: [cityId], references: [id])

  @@map("delivery_schedules")
}

model RequestStatusHistory {
  id        Int           @id @default(autoincrement())
  requestId Int           @map("request_id")
  oldStatus RequestStatus @map("old_status")
  newStatus RequestStatus @map("new_status")
  changedAt DateTime      @default(now()) @map("changed_at")

  request   ShipmentRequest @relation(fields: [requestId], references: [id])

  @@map("request_status_history")
}

model RequestService {
  id          Int             @id @default(autoincrement())
  requestId   Int             @map("request_id")
  description String
  unit        String          @default("шт")
  quantity    Float           @default(1)
  price       Float           @default(0)
  amount      Float           @default(0)
  createdAt   DateTime        @default(now()) @map("created_at")

  request     ShipmentRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@map("request_services")
}

model RequestFieldHistory {
  id        Int      @id @default(autoincrement())
  requestId Int      @map("request_id")
  managerId Int      @map("manager_id")
  field     String
  oldValue  String?  @map("old_value")
  newValue  String?  @map("new_value")
  changedAt DateTime @default(now()) @map("changed_at")

  request   ShipmentRequest @relation(fields: [requestId], references: [id])
  manager   Manager         @relation(fields: [managerId], references: [id])

  @@map("request_field_history")
}

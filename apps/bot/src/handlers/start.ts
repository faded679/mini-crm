import type { Context } from "grammy";
import { env } from "../env.js";
import { checkConsent } from "../api.js";

const CONSENT_TEXT =
  "üìã <b>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</b>\n\n" +
  "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∞—à–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n\n" +
  "–ú—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:\n" +
  "‚Ä¢ Telegram ID, –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è\n" +
  "‚Ä¢ –î–∞–Ω–Ω—ã–µ –æ –∑–∞—è–≤–∫–∞—Ö –Ω–∞ –ø–µ—Ä–µ–≤–æ–∑–∫—É (–≥–æ—Ä–æ–¥, –¥–∞—Ç–∞, –≥–∞–±–∞—Ä–∏—Ç—ã, –≤–µ—Å)\n\n" +
  "–î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–µ—Ä–µ–≤–æ–∑–∫—É –≥—Ä—É–∑–æ–≤ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.\n\n" +
  "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.";

const WELCOME_TEXT =
  "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Mini-CRM –±–æ—Ç! üì¶\n\n" +
  "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–µ—Ä–µ–≤–æ–∑–∫—É –≥—Ä—É–∑–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å.\n\n" +
  "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
  "/new ‚Äî –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É\n" +
  "/my ‚Äî –ú–æ–∏ –∑–∞—è–≤–∫–∏";

export async function handleStart(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;
  if (!userId) return;

  try {
    const { consentGiven } = await checkConsent(String(userId));

    if (consentGiven) {
      await ctx.reply(WELCOME_TEXT, {
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: "üì¶ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
                web_app: { url: env.MINI_APP_URL },
              },
            ],
          ],
        },
      });
    } else {
      await ctx.reply(CONSENT_TEXT, {
        parse_mode: "HTML",
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: "‚úÖ –î–∞—é —Å–æ–≥–ª–∞—Å–∏–µ",
                callback_data: "consent_accept",
              },
            ],
          ],
        },
      });
    }
  } catch {
    await ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
}
